<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FICHA DE VALORACIÓN COMERCIAL</title>
    <!-- Librerías para PDF, Excel y para Imagen (html2canvas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #0c4586;
            --secondary-color: #f5f5f5;
            --text-color: #333;
            --border-color: #ddd;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-success: #e9f7eb;
            --light-warning: #fff8e6;
            --light-danger: #fbebee;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            position: relative;
            background-color: white;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
        }
        
        #manage-data-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            transition: color 0.3s;
        }
        #manage-data-button:hover {
            color: var(--primary-color);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-content h2 { margin-top: 0; }
        .modal-close-button {
            float: right;
            border: none;
            background: transparent;
            font-size: 34px;
            cursor: pointer;
        }
        .modal-close-button{
            color: #000000;
        }
        #saved-data-list {
            list-style-type: none;
            padding: 0;
            margin-top: 20px;
        }
        #saved-data-list li {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        #saved-data-list li:last-child { border-bottom: none; }
        .entry-info { flex-grow: 1; }
        .entry-info span { display: block; }
        .entry-info .company-name { font-weight: bold; }
        .entry-info .entry-meta { font-size: 0.9em; color: #666; }
        .entry-actions button {
            margin-left: 10px;
            padding: 8px 12px;
            font-size: 14px;
        }
        h1, h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
        }
        #results-header {
            text-align: center;
             margin-bottom: 20px;
        }
        #results-company-name {
             color: var(--primary-color);
             font-size: 24px;
             font-weight: bold;
        }
        .img {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            border-radius: 50%;
        }
        .form-phase { display: none; }
        .form-phase.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input[type="text"], input[type="email"], input[type="number"], select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        textarea { resize: vertical; min-height: 100px; }
        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        .radio-group label, .checkbox-group label {
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 10px;
            flex-wrap: wrap;
        }
        button, .button-like {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            flex-grow: 1;
            text-align: center;
            text-decoration: none;
        }
        button.secondary-action, .button-like.secondary-action { background-color: #6c757d; }
        button.secondary-action:hover, .button-like.secondary-action:hover { background-color: #5a6268; }
        .return-button {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 8px 15px;
            font-size: 14px;
            flex-grow: 0;
            margin-bottom: 20px;
        }

        .success {
            background-color: var(--success-color)!important;
        }

        .return-button:hover { background-color: #eef5ff; }
        button:hover, .button-like:hover { background-color: #357ABD; transform: translateY(-2px); }
        button.prev { background-color: #ccc; }
        button.prev:hover { background-color: #bbb; }
        button.danger { background-color: var(--danger-color); }
        button.danger:hover { background-color: #c82333; }
        .hidden { display: none; }
        .progress-bar {
            width: 100%;
            background-color: var(--secondary-color);
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        .progress {
            width: 0;
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 10px;
            transition: width 0.5s ease-in-out;
        }
        #results { margin-top: 30px; }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .results-table th, .results-table td { border: 1px solid var(--border-color); padding: 12px; text-align: left; }
        .results-table th { background-color: var(--secondary-color); }
        .traffic-light-container { text-align: center; margin-bottom: 20px; }
        .traffic-light { display: inline-block; background-color: #333; padding: 15px; border-radius: 20px; }
        .light { width: 50px; height: 50px; border-radius: 50%; background-color: #555; margin: 10px; opacity: 0.3; }
        .light.active { opacity: 1; }
        #red-light { background-color: var(--danger-color); }
        #yellow-light { background-color: var(--warning-color); }
        #green-light { background-color: var(--success-color); }
        .status-cell { text-align: center; font-weight: bold; }
        .status-dot { height: 15px; width: 15px; border-radius: 50%; display: inline-block; }
        .status-red { background-color: var(--danger-color); }
        .status-yellow { background-color: var(--warning-color); }
        .status-green { background-color: var(--success-color); }
        .total-score-cell.red { background-color: var(--light-danger); color: var(--danger-color); }
        .total-score-cell.yellow { background-color: var(--light-warning); color: var(--warning-color); }
        .total-score-cell.green { background-color: var(--light-success); color: var(--success-color); }
        @media (max-width: 600px) {
            .container { padding: 20px; }
            .button-group button { width: 100%; }
            .entry-actions { margin-top: 10px; width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
     <button id="manage-data-button" title="Consultar datos guardados">⚙️</button>
     
    <div id="form-container">
        <h1>FICHA DE VALORACIÓN COMERCIAL</h1>
        <h2>Proyecto de comercialización y ferias</h2>
        <div class="img">
            <img src="https://www.cauca.gov.co/SiteAssets/images/logo-encabezado.png" alt="Logo Gobernación del Cauca" srcset="">
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        <form id="commercial-form">
            <!-- Phase 1: Información General -->
            <div class="form-phase active" id="phase-1">
                <h2>1. Información General de la Empresa</h2>
                 <div class="form-group">
                    <label for="nombre_empresa">Nombre de la empresa:</label>
                    <input type="text" id="nombre_empresa" name="nombre_empresa" required>
                </div>
                <div class="form-group">
                    <label for="nit">NIT (usado como identificador único):</label>
                    <input type="text" id="nit" name="nit" required>
                </div>
                 <div class="form-group">
                    <label for="ubicacion">Ubicación (Municipio/vereda):</label>
                    <input type="text" id="ubicacion" name="ubicacion">
                </div>
                <div class="form-group">
                    <label for="tipo_organizacion">¿Qué tipo de organización es?</label>
                    <input type="text" id="tipo_organizacion" name="tipo_organizacion" placeholder="Ej. Empresa individual, asociación, cooperativa, otro">
                </div>
                <div class="form-group">
                    <label for="tipo_productos_servicios">Tipo de productos y/o servicios:</label>
                    <input type="text" id="tipo_productos_servicios" name="tipo_productos_servicios">
                </div>
                <div class="form-group">
                    <label for="tiempo_conformacion">Tiempo de conformación Unidad Economica y/o emprendimiento:</label>
                    <input type="text" id="tiempo_conformacion" name="tiempo_conformacion">
                </div>
                <div class="form-group">
                    <label for="representante_legal">Representante legal o responsable del área comercial:</label>
                    <input type="text" id="representante_legal" name="representante_legal">
                </div>
                <div class="form-group">
                    <label for="numero_colaboradores">Número de colaboradores:</label>
                    <input type="number" id="numero_colaboradores" name="numero_colaboradores" min="0">
                </div>
                <div class="form-group">
                    <label for="correo_electronico">Correo electrónico:</label>
                    <input type="email" id="correo_electronico" name="correo_electronico">
                </div>
                <div class="form-group">
                    <label for="celular">Celular:</label>
                    <input type="text" id="celular" name="celular">
                </div>
            </div>

            <!-- Phase 2: Presencia en Medios y Canales Digitales -->
            <div class="form-phase" id="phase-2">
                <h2>2. Presencia en Medios y Canales Digitales</h2>
                <div class="form-group">
                    <label>¿La empresa tiene redes sociales activas?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="redes_sociales_activas" value="si" data-score="5" onclick="toggleConditional('redes_sociales_details', true)"> Sí</label>
                        <label><input type="radio" name="redes_sociales_activas" value="no" data-score="0" onclick="toggleConditional('redes_sociales_details', false)"> No</label>
                    </div>
                </div>
                <div id="redes_sociales_details" class="hidden">
                     <div class="form-group">
                        <label>Plataformas utilizadas:</label>
                        <div class="checkbox-group">
                           <label><input type="checkbox" name="plataformas" value="Facebook" data-score="1"> Facebook</label>
                           <label><input type="checkbox" name="plataformas" value="Instagram" data-score="1"> Instagram</label>
                           <label><input type="checkbox" name="plataformas" value="TikTok" data-score="1"> TikTok</label>
                           <label><input type="checkbox" name="plataformas" value="WhatsApp Business" data-score="1"> WhatsApp Business</label>
                           <label><input type="checkbox" name="plataformas" value="YouTube" data-score="1"> YouTube</label>
                           <label><input type="checkbox" name="plataformas" value="Pagina web" data-score="2"> Página web</label>
                           <label><input type="checkbox" name="plataformas" value="Tienda en linea" data-score="3"> Tienda en línea</label>
                           <label><input type="checkbox" name="plataformas" value="Otra"> Otra</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Modo de uso:</label>
                         <div class="checkbox-group">
                           <label><input type="checkbox" name="modo_uso" value="Personal" data-score="1"> Uso personal y entretenimiento</label>
                           <label><input type="checkbox" name="modo_uso" value="Atencion cliente" data-score="3"> Atención al cliente y ventas</label>
                           <label><input type="checkbox" name="modo_uso" value="Publicidad" data-score="5"> Publicidad y promoción</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Phase 3: Estrategias Comerciales y de Ventas -->
            <div class="form-phase" id="phase-3">
                <h2>3. Estrategias Comerciales y de Ventas</h2>
                <div class="form-group">
                    <label>¿Cuenta con una estrategia comercial definida?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="estrategia_definida" value="si" data-score="10" onclick="toggleConditional('estrategia_descripcion', true)"> Sí</label>
                        <label><input type="radio" name="estrategia_definida" value="no" data-score="0" onclick="toggleConditional('estrategia_descripcion', false)"> No</label>
                    </div>
                </div>
                <div id="estrategia_descripcion" class="form-group hidden">
                    <label for="descripcion_estrategia">Descripción breve:</label>
                    <textarea id="descripcion_estrategia" name="descripcion_estrategia"></textarea>
                </div>
                <div class="form-group">
                    <label>Canales de venta utilizados:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="canales_venta" value="Tienda fisica" data-score="3"> Tienda física</label>
                        <label><input type="checkbox" name="canales_venta" value="Pagina web" data-score="5"> Página web</label>
                        <label><input type="checkbox" name="canales_venta" value="Distribuidores" data-score="4"> Distribuidores</label>
                    </div>
                </div>
                 <div class="form-group">
                    <label>¿Cuenta con un equipo comercial o de ventas?</label>
                     <div class="radio-group">
                        <label><input type="radio" name="equipo_ventas" value="si" data-score="5" onclick="toggleConditional('equipo_ventas_numero', true)"> Sí</label>
                        <label><input type="radio" name="equipo_ventas" value="no" data-score="0" onclick="toggleConditional('equipo_ventas_numero', false)"> No</label>
                     </div>
                </div>
                 <div id="equipo_ventas_numero" class="form-group hidden">
                    <label for="numero_personas_ventas">Número de personas:</label>
                    <input type="number" id="numero_personas_ventas" name="numero_personas_ventas" min="1">
                </div>
                <div class="form-group">
                    <label>¿Tiene metas de ventas definidas?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="metas_ventas" value="si" data-score="5"> Sí</label>
                        <label><input type="radio" name="metas_ventas" value="no" data-score="0"> No</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>¿Se hace seguimiento periódico?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="seguimiento_periodico" value="si" data-score="5"> Sí</label>
                        <label><input type="radio" name="seguimiento_periodico" value="no" data-score="0"> No</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>a) Conocimiento del mercado:</label>
                    <div class="radio-group" style="flex-direction:column; align-items:flex-start;">
                        <label><input type="radio" name="conocimiento_mercado" value="no estudiado" data-score="0"> No hemos estudiado bien a nuestros clientes.</label>
                        <label><input type="radio" name="conocimiento_mercado" value="datos basicos" data-score="3"> Tenemos datos básicos, pero falta profundizar.</label>
                        <label><input type="radio" name="conocimiento_mercado" value="analizamos constantemente" data-score="8"> Analizamos constantemente el mercado y ajustamos estrategias.</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>b) Estrategia de ventas:</label>
                    <div class="radio-group" style="flex-direction:column; align-items:flex-start;">
                        <label><input type="radio" name="estrategia_ventas" value="informal" data-score="2"> Vendemos informalmente, sin procesos claros.</label>
                        <label><input type="radio" name="estrategia_ventas" value="metodo no efectivo" data-score="6"> Tenemos un método de ventas, pero no siempre es efectivo.</label>
                    </div>
                </div>
            </div>

            <!-- Phase 4: Relación con Clientes -->
            <div class="form-phase" id="phase-4">
                <h2>4. Relación con Clientes</h2>
                <div class="form-group">
                    <label>¿Cuenta con una base de datos de clientes?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="base_datos_clientes" value="si" data-score="10"> Sí</label>
                        <label><input type="radio" name="base_datos_clientes" value="no" data-score="0"> No</label>
                    </div>
                </div>
                 <div class="form-group">
                    <label>¿A traves de que medios comercializa sus productos o servicios?</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="medios_comercializacion" value="Grandes superficies" data-score="4"> Grandes superficies</label>
                        <label><input type="checkbox" name="medios_comercializacion" value="Distribuidores mayoristas" data-score="4"> Distribuidores mayoristas</label>
                        <label><input type="checkbox" name="medios_comercializacion" value="Venta directa" data-score="3"> Venta directa</label>
                        <label><input type="checkbox" name="medios_comercializacion" value="Punto de venta propio" data-score="5"> Punto de venta propio</label>
                        <label><input type="checkbox" name="medios_comercializacion" value="Otro" data-score="1"> Otro</label>
                    </div>
                </div>
                 <div class="form-group">
                    <label>¿Cómo gestiona solicitudes y reclamos?:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="gestion_reclamos" value="Manualmente" data-score="2"> Manualmente</label>
                        <label><input type="checkbox" name="gestion_reclamos" value="Correo electronico" data-score="4"> Correo electrónico</label>
                        <label><input type="checkbox" name="gestion_reclamos" value="WhatsApp" data-score="4"> WhatsApp</label>
                        <label><input type="checkbox" name="gestion_reclamos" value="Software especializado" data-score="8"> Software especializado</label>
                        <label><input type="checkbox" name="gestion_reclamos" value="No se gestiona formalmente" data-score="0"> No se gestiona formalmente</label>
                    </div>
                </div>
            </div>

            <!-- Phase 5: Publicidad y Promoción -->
            <div class="form-phase" id="phase-5">
                <h2>5. Publicidad y Promoción</h2>
                <div class="form-group">
                    <label>¿Invierte en campañas promocionales?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="invierte_campanas" value="si" data-score="10" onclick="toggleConditional('campanas_details', true)"> Sí</label>
                        <label><input type="radio" name="invierte_campanas" value="no" data-score="0" onclick="toggleConditional('campanas_details', false)"> No</label>
                    </div>
                </div>
                <div id="campanas_details" class="hidden">
                    <div class="form-group">
                        <label>Canales utilizados:</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="canales_promocion" value="Redes sociales" data-score="5"> Redes sociales</label>
                            <label><input type="checkbox" name="canales_promocion" value="Radio" data-score="2"> Radio</label>
                            <label><input type="checkbox" name="canales_promocion" value="Volantes / impresos" data-score="2"> Volantes / impresos</label>
                            <label><input type="checkbox" name="canales_promocion" value="Alianzas comerciales" data-score="4"> Alianzas comerciales</label>
                            <label><input type="checkbox" name="canales_promocion" value="Ferias / eventos" data-score="3"> Ferias / eventos</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Frecuencia:</label>
                        <div class="radio-group" style="flex-direction:column; align-items:flex-start;">
                            <label><input type="radio" name="frecuencia_campanas" value="diaria" data-score="5"> Diaria</label>
                            <label><input type="radio" name="frecuencia_campanas" value="semanal" data-score="3"> Semanales</label>
                            <label><input type="radio" name="frecuencia_campanas" value="mensual" data-score="2"> Mensuales</label>
                        </div>
                    </div>
                </div>
                 <div class="form-group">
                    <label>¿Cuenta con un plan de marketing?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="plan_marketing" value="si" data-score="10"> Sí</label>
                        <label><input type="radio" name="plan_marketing" value="no" data-score="0"> No</label>
                    </div>
                </div>
            </div>

            <!-- Phase 6: Análisis de Precios y Competencia -->
            <div class="form-phase" id="phase-6">
                 <h2>6. Análisis de Precios y Competencia</h2>
                <div class="form-group">
                    <label>¿Tiene estrategia de precios?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="estrategia_precios" value="si" data-score="8"> Sí</label>
                        <label><input type="radio" name="estrategia_precios" value="no" data-score="0"> No</label>
                    </div>
                </div>
                 <div class="form-group">
                    <label>¿Sus precios son competitivos?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="precios_competitivos" value="si" data-score="5"> Sí</label>
                        <label><input type="radio" name="precios_competitivos" value="no" data-score="0"> No</label>
                        <label><input type="radio" name="precios_competitivos" value="no lo sabe" data-score="0"> No lo sabe</label>
                    </div>
                </div>
                 <div class="form-group">
                    <label>¿Tiene identificados a sus competidores?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="competidores_identificados" value="si" data-score="8" onclick="toggleConditional('competidores_details', true)"> Sí</label>
                        <label><input type="radio" name="competidores_identificados" value="no" data-score="0" onclick="toggleConditional('competidores_details', false)"> No</label>
                    </div>
                </div>
                <div id="competidores_details" class="hidden">
                    <div class="form-group">
                        <label for="competidor_1">Competidor 1:</label>
                        <input type="text" id="competidor_1" name="competidor_1">
                    </div>
                     <div class="form-group">
                        <label for="competidor_2">Competidor 2:</label>
                        <input type="text" id="competidor_2" name="competidor_2">
                    </div>
                </div>
                <div class="form-group">
                    <label>¿Qué diferencia su oferta?:</label>
                     <div class="checkbox-group">
                        <label><input type="checkbox" name="diferencia_oferta" value="Precio" data-score="3"> Precio</label>
                        <label><input type="checkbox" name="diferencia_oferta" value="Calidad" data-score="5"> Calidad</label>
                        <label><input type="checkbox" name="diferencia_oferta" value="Servicio" data-score="4"> Servicio</label>
                        <label><input type="checkbox" name="diferencia_oferta" value="Rapidez" data-score="3"> Rapidez</label>
                        <label><input type="checkbox" name="diferencia_oferta" value="Experiencia del cliente" data-score="5"> Experiencia del cliente</label>
                        <label><input type="checkbox" name="diferencia_oferta" value="Otra" data-score="1"> Otra:</label>
                    </div>
                </div>
            </div>

            <!-- Phase 7: Diagnóstico, Cliente Ideal y Capacitación -->
            <div class="form-phase" id="phase-7">
                <h2>7, 8 y 9. Diagnóstico, Cliente Ideal y Capacitación</h2>
                <div class="form-group">
                    <label for="fortaleza_comercial">Fortaleza comercial (factores internos):</label>
                    <textarea id="fortaleza_comercial" name="fortaleza_comercial"></textarea>
                </div>
                 <div class="form-group">
                    <label for="debilidad_comercial">Debilidad comercial (factores internos):</label>
                    <textarea id="debilidad_comercial" name="debilidad_comercial"></textarea>
                </div>
                 <div class="form-group">
                    <label for="oportunidad_mejora_comercial">Oportunidad de mejora sector comercial (factores externos):</label>
                    <textarea id="oportunidad_mejora_comercial" name="oportunidad_mejora_comercial"></textarea>
                </div>
                <div class="form-group">
                    <label for="amenaza_comercial">Amenaza comercial (factores externos):</label>
                    <textarea id="amenaza_comercial" name="amenaza_comercial"></textarea>
                </div>
                <hr style="margin: 25px 0;">
                <div class="form-group">
                    <label>¿Tiene identificado a su cliente ideal?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="cliente_ideal_identificado" value="si" data-score="10"> Sí</label>
                        <label><input type="radio" name="cliente_ideal_identificado" value="no" data-score="0"> No</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>¿Cuál es su segmento de mercado principal?</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="segmento_mercado" value="Consumidor final" data-score="3"> Consumidor final</label>
                        <label><input type="checkbox" name="segmento_mercado" value="Empresas" data-score="3"> Empresas</label>
                        <label><input type="checkbox" name="segmento_mercado" value="Instituciones / Gobierno" data-score="3"> Instituciones / Gobierno</label>
                        <label><input type="checkbox" name="segmento_mercado" value="Otro" data-score="1"> Otro</label>
                    </div>
                </div>
                 <div class="form-group">
                    <label>¿Ha realizado estudios o encuestas para conocer sus clientes?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="estudios_clientes" value="si" data-score="8"> Sí</label>
                        <label><input type="radio" name="estudios_clientes" value="no" data-score="0"> No</label>
                    </div>
                </div>
                <hr style="margin: 25px 0;">
                <div class="form-group">
                    <label>¿El equipo comercial ha recibido formación reciente?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="formacion_reciente" value="si" data-score="10" onclick="toggleConditional('formacion_details', true)"> Sí</label>
                        <label><input type="radio" name="formacion_reciente" value="no" data-score="0" onclick="toggleConditional('formacion_details', false)"> No</label>
                    </div>
                </div>
                <div id="formacion_details" class="form-group hidden">
                     <label>Temas trabajados:</label>
                     <div class="checkbox-group">
                        <label><input type="checkbox" name="temas_trabajados" value="Tecnicas de ventas" data-score="4"> Técnicas de ventas</label>
                        <label><input type="checkbox" name="temas_trabajados" value="Servicio al cliente" data-score="4"> Servicio al cliente</label>
                        <label><input type="checkbox" name="temas_trabajados" value="Negociacion" data-score="3"> Negociación</label>
                        <label><input type="checkbox" name="temas_trabajados" value="Marketing digital" data-score="5"> Marketing digital</label>
                        <label><input type="checkbox" name="temas_trabajados" value="Software especializado" data-score="4"> Software especializado</label>
                        <label><input type="checkbox" name="temas_trabajados" value="Otro" data-score="1"> Otro</label>
                     </div>
                </div>
            </div>
            
            <!-- Phase 8: Innovación, Habilidades y Eventos -->
            <div class="form-phase" id="phase-8">
                <h2>10, 11 y 12. Innovación, Habilidades y Eventos</h2>
                 <div class="form-group">
                    <label>¿Ha innovado recientemente?:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="innovacion_reciente" value="Nuevos productos/servicios" data-score="5"> Nuevos productos/servicios</label>
                        <label><input type="checkbox" name="innovacion_reciente" value="Nuevos canales de venta" data-score="4"> Nuevos canales de venta</label>
                        <label><input type="checkbox" name="innovacion_reciente" value="Digitalizacion" data-score="3"> Digitalización</label>
                        <label><input type="checkbox" name="innovacion_reciente" value="Experiencia del cliente" data-score="5"> Experiencia del cliente</label>
                        <label><input type="checkbox" name="innovacion_reciente" value="Otro" data-score="1"> Otro</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>¿Prevé innovaciones este año?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="preve_innovaciones" value="si" data-score="8" onclick="toggleConditional('innovaciones_cual', true)"> Sí</label>
                        <label><input type="radio" name="preve_innovaciones" value="no" data-score="0" onclick="toggleConditional('innovaciones_cual', false)"> No</label>
                    </div>
                </div>
                <div id="innovaciones_cual" class="form-group hidden">
                    <label for="cual_innovacion">¿Cuál?:</label>
                    <input type="text" id="cual_innovacion" name="cual_innovacion">
                </div>
                <hr style="margin: 25px 0;">
                <div class="form-group">
                    <label>¿Con cual de las siguientes afirmaciones te identificas?</label>
                    <div class="checkbox-group" style="flex-direction:column; align-items:flex-start;">
                        <label><input type="checkbox" name="habilidades_blandas" value="comunicacion asertiva" data-score="10"> Me comunico de forma asertiva con los clientes, escuchando activamente, expresándome con claridad y gestionando conflictos de manera empática.</label>
                        <label><input type="checkbox" name="habilidades_blandas" value="trabajo en equipo" data-score="8"> Trabajo en equipo y me adapto a los desafíos comerciales, colaborando con otros para alcanzar metas y respondiendo con resiliencia ante dificultades o ventas no logradas.</label>
                        <label><input type="checkbox" name="habilidades_blandas" value="mejora constante" data-score="8"> Estoy en constante mejora personal y profesional, aprendiendo nuevas técnicas y estrategias para fortalecer mi trato con los clientes y crecer en mi rol.</label>
                    </div>
                </div>
                 <hr style="margin: 25px 0;">
                 <div class="form-group">
                    <label>¿Ha participado en eventos como: (ferias, ruedas de negocio, eventos institucionales, etc)?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="participacion_eventos" value="si" data-score="8" onclick="toggleConditional('eventos_cuales', true)"> Sí</label>
                        <label><input type="radio" name="participacion_eventos" value="no" data-score="0" onclick="toggleConditional('eventos_cuales', false)"> No</label>
                    </div>
                </div>
                <div id="eventos_cuales" class="form-group hidden">
                    <label for="cuales_eventos">¿Cuáles?:</label>
                    <input type="text" id="cuales_eventos" name="cuales_eventos">
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="button-group">
                <button type="button" class="prev" id="prevBtn" onclick="nextPrev(-1)" style="display:none;">Anterior</button>
                <button type="button" id="nextBtn" onclick="nextPrev(1)">Siguiente</button>
            </div>
        </form>
    </div>

    <!-- Results Section -->
    <div id="results-capture-area">
        <div id="results" class="hidden">
            <button class="return-button" onclick="returnToForm()">← Volver y Corregir</button>
            <div id="results-header">
                <div id="results-company-name"></div>
                <h3>Resultados de valoración comercial</h3>
            </div>
            <div class="traffic-light-container">
                <div class="traffic-light">
                    <div class="light" id="red-light"></div>
                    <div class="light" id="yellow-light"></div>
                    <div class="light" id="green-light"></div>
                </div>
                <h2 id="final-score-text"></h2>
            </div>
            <table class="results-table" id="results-table">
                <thead>
                    <tr>
                        <th>Aspecto Evaluado</th>
                        <th>Calificación (0-50)</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be inserted here by JavaScript -->
                </tbody>
                <tfoot>
                    <tr>
                        <th>NIVEL DE DESARROLLO GENERAL (0-50)</th>
                        <th id="total-score" class="total-score-cell"></th>
                        <th id="total-status-cell"></th>
                    </tr>
                </tfoot>
            </table>
            <div class="button-group">
                 <button type="button" class="secondary-action" onclick="downloadResultsImage()">Descargar Imagen</button>
                <button type="button" class="secondary-action" onclick="downloadPDF()">Descargar Ficha PDF</button>
                <!-- <button type="button" class="secondary-action" onclick="downloadExcelSummary()">Resumen (Excel)</button> -->
                <!-- <button type="button" class="secondary-action" onclick="downloadExcelAllData()">Matriz de Datos (Excel)</button> -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para gestionar datos guardados -->
<div class="modal-overlay" id="manage-data-modal">
    <div class="modal-content">
        <button class="modal-close-button" onclick="closeModal()">×</button>
        <h2>Gestión de datos almacenados</h2>
        <p>Aquí puedes ver, cargar, eliminar o descargar los formularios que has completado.</p>
        
        <div class="button-group" style="justify-content: center; margin-bottom: 20px;">
            <button type="button" class="secondary-action success" onclick="downloadExcelAllData()">Descargar Matriz de Datos (Excel)</button>
        </div>

        <ul id="saved-data-list">
            <!-- Los datos guardados se insertarán aquí -->
        </ul>
    </div>
</div>


<script>
// Make sure jsPDF is loaded
const { jsPDF } = window.jspdf;

// === DEFINITIVE FIX: Verified, complete Base64 string for the logo ===
const logoBase64 = 'data:image/png;base64,iVBORw0K';

let currentPhase = 0;
const phases = document.querySelectorAll(".form-phase");
const progress = document.getElementById("progress");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const totalPhases = phases.length;

let resultsForExport = [];

document.addEventListener('DOMContentLoaded', () => {
    showPhase(currentPhase);
    document.getElementById('manage-data-button').addEventListener('click', openModal);
});

function showPhase(n) {
    phases.forEach((phase, index) => {
        phase.style.display = (index === n) ? "block" : "none";
        if(index === n) phase.classList.add('active');
        else phase.classList.remove('active');
    });
    prevBtn.style.display = (n === 0) ? "none" : "inline-block";
    nextBtn.innerHTML = (n === totalPhases - 1) ? "Finalizar" : "Siguiente";
    updateProgressBar();
}

function nextPrev(n) {
    if (n === 1 && !validateForm()) return false;
    
    const nextPhaseIndex = currentPhase + n;
    
    if (nextPhaseIndex >= totalPhases) {
        phases[currentPhase].style.display = 'none';
        document.getElementById('form-container').style.display = 'none';
        document.getElementById('results').classList.remove('hidden');
        document.getElementById('results-company-name').textContent = document.getElementById('nombre_empresa').value;
        calculateResults();
        saveDataToLocalStorage();
        currentPhase = nextPhaseIndex - 1; 
        return false;
    }
    
    currentPhase += n;
    showPhase(currentPhase);
}

function validateForm() {
    let valid = true;
    const currentInputs = phases[currentPhase].querySelectorAll("input[required], select[required]");
    currentInputs.forEach(input => {
        if (!input.value.trim()) {
            input.style.borderColor = "var(--danger-color)";
            valid = false;
        } else {
            input.style.borderColor = "var(--border-color)";
        }
    });
    if (currentPhase === 0) {
        const nitInput = document.getElementById('nit');
        if (!nitInput.value.trim()) {
            alert('El campo NIT es obligatorio para poder guardar y gestionar los datos.');
            nitInput.style.borderColor = "var(--danger-color)";
            valid = false;
        }
    }
    return valid;
}

function updateProgressBar() {
    progress.style.width = `${((currentPhase + 1) / totalPhases) * 100}%`;
}

function toggleConditional(elementId, show) {
    const element = document.getElementById(elementId);
    element.classList.toggle('hidden', !show);
    if (!show) {
        element.querySelectorAll('input, textarea').forEach(input => {
             if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
             else input.value = '';
        });
    }
}

function returnToForm() {
    document.getElementById('results').classList.add('hidden');
    document.getElementById('form-container').style.display = 'block';
    showPhase(currentPhase);
}

function getStatus(score) {
    if (score <= 17) return { colorClass: 'red', dotClass: 'status-red', text: 'Básico' };
    if (score <= 34) return { colorClass: 'yellow', dotClass: 'status-yellow', text: 'Intermedio' };
    return { colorClass: 'green', dotClass: 'status-green', text: 'Avanzado' };
}



function calculateResults() {
    const sections = [
        { name: "Presencia Digital", id: 'phase-2' },
        { name: "Estrategias de Ventas", id: 'phase-3' },
        { name: "Relación con Clientes", id: 'phase-4' },
        { name: "Publicidad y Promoción", id: 'phase-5' },
        { name: "Precios y Competencia", id: 'phase-6' },
        { name: "Diagnóstico y Formación", id: 'phase-7' },
        { name: "Innovación y Eventos", id: 'phase-8' },
    ];
    
    const resultsBody = document.querySelector("#results-table tbody");
    resultsBody.innerHTML = '';
    resultsForExport = [];
    let totalNormalizedScore = 0;
    
    sections.forEach(section => {
        let sectionScore = 0;
        let sectionMaxScore = 0;

        const phaseElement = document.getElementById(section.id);
        const checkedInputs = phaseElement.querySelectorAll("input:checked");
        checkedInputs.forEach(input => sectionScore += parseInt(input.dataset.score || 0));

        const allInputs = phaseElement.querySelectorAll('input[type="radio"], input[type="checkbox"]');
        const radioGroups = {};
        allInputs.forEach(opt => {
            const score = parseInt(opt.dataset.score || 0);
            if (opt.type === 'radio') {
                if (!radioGroups[opt.name]) radioGroups[opt.name] = 0;
                if (score > radioGroups[opt.name]) radioGroups[opt.name] = score;
            } else if(opt.type === 'checkbox') {
                sectionMaxScore += score;
            }
        });
        Object.values(radioGroups).forEach(max => sectionMaxScore += max);
        
        const normalizedScore = sectionMaxScore > 0 ? Math.round((sectionScore / sectionMaxScore) * 50) : 50;
        totalNormalizedScore += normalizedScore;
        
        const status = getStatus(normalizedScore);
        const row = resultsBody.insertRow();
        row.insertCell(0).textContent = section.name;
        // CORRECTION: Display the score with "/50"
        row.insertCell(1).textContent = `${normalizedScore}/50`;
        const statusCell = row.insertCell(2);
        statusCell.classList.add('status-cell');
        statusCell.innerHTML = `<span class="status-dot ${status.dotClass}"></span>`;
        
        resultsForExport.push({
            Aspecto: section.name,
            "Calificacion (0-50)": normalizedScore, // Keep numeric for Excel, format in PDF
            Estado: status.text
        });
    });

    const averageScore = Math.round(totalNormalizedScore / sections.length);
    const totalStatus = getStatus(averageScore);
    
    // CORRECTION: Display the total score with "/50"
    document.getElementById('total-score').textContent = `${averageScore}/50`;
    document.getElementById('total-score').className = `total-score-cell ${totalStatus.colorClass}`;
    document.getElementById('total-status-cell').innerHTML = `<span class="status-dot ${totalStatus.dotClass}"></span>`;

    const lights = document.querySelectorAll('.traffic-light .light');
    lights.forEach(light => light.classList.remove('active'));
    const mainLight = document.getElementById(`${totalStatus.colorClass}-light`);
    if(mainLight) mainLight.classList.add('active');

    const scoreText = document.getElementById('final-score-text');
    scoreText.style.color = `var(--${totalStatus.colorClass}-color)`;
    scoreText.textContent = `Nivel de Desarrollo: ${totalStatus.text}`;
}

// --- DOWNLOAD FUNCTIONS ---

function downloadResultsImage() {
    // --- 1. PREPARACIÓN DEL ENTORNO ---
    const originalNode = document.getElementById('results-capture-area');
    const companyName = document.getElementById('nombre_empresa').value.replace(/\s/g, '_') || 'sin_nombre';

    // Creamos un clon del nodo de resultados. Este es el secreto.
    const clone = originalNode.cloneNode(true);
    clone.id = 'capture-clone'; // Le damos un ID para que no haya conflictos

    // Estilizamos el clon para que sea invisible al usuario, pero renderizable por el navegador.
    clone.style.position = 'absolute';
    clone.style.top = '0';
    clone.style.left = '-9999px'; // Lo mandamos muy lejos a la izquierda
    clone.style.width = '450px'; // Aplicamos el ancho de "versión móvil"
    clone.style.backgroundColor = 'white'; // Aseguramos un fondo blanco sólido
    clone.style.padding = '30px'; // Un padding consistente
    clone.style.boxSizing = 'border-box';

    // --- 2. MODIFICACIÓN DEL CLON (NO DE LA VISTA REAL) ---
    // Todas las modificaciones se hacen en el clon, la vista del usuario no parpadea ni cambia.

    // Ocultamos los botones en el clon
    clone.querySelector('.return-button').style.display = 'none';
    clone.querySelector('.button-group').style.display = 'none';

    // Obtenemos el estado de la vista original para aplicarlo al clon
    const originalActiveLight = originalNode.querySelector('.light.active');
    
    // <<< LA SOLUCIÓN REAL PARA LA LUZ DEL SEMÁFORO >>>
    if (originalActiveLight) {
        // Encontramos la luz correspondiente en el CLON usando su ID
        const clonedActiveLight = clone.querySelector('#' + originalActiveLight.id);
        if (clonedActiveLight) {
            // En lugar de jugar con clases, aplicamos el estilo más directo posible al CLON.
            clonedActiveLight.style.opacity = '1';
        }
    }
    
    // Aplicamos el color directo al texto del puntaje en el CLON
    const colorMap = { red: '#dc3545', yellow: '#ffc107', green: '#28a745' };
    const totalScoreCell = originalNode.querySelector('#total-score'); // Leemos la clase del original
    let colorClass = 'red';
    if (totalScoreCell.classList.contains('yellow')) colorClass = 'yellow';
    else if (totalScoreCell.classList.contains('green')) colorClass = 'green';
    clone.querySelector('#final-score-text').style.color = colorMap[colorClass];

    // --- 3. CAPTURA Y LIMPIEZA ---
    
    // Añadimos el clon preparado al cuerpo del documento
    document.body.appendChild(clone);

    // Damos un respiro al navegador para que renderice el clon
    setTimeout(() => {
        // Ahora, le pedimos a html2canvas que capture el CLON, no el nodo original.
        html2canvas(clone, {
            scale: 2,
            useCORS: true // Mejora la compatibilidad con imágenes
        }).then(canvas => {
            // En cuanto tenemos la imagen, eliminamos el clon del documento.
            document.body.removeChild(clone);

            // Procedemos a la descarga
            const image = canvas.toDataURL("image/png");
            const link = document.createElement('a');
            link.download = `Resultados_Valoracion_${companyName}.png`;
            link.href = image;
            link.click();
        });
    }, 100); // 100ms es un tiempo seguro para el renderizado.
}



function getStatusText(statusKey) {
    const statusMap = {
        'red': 'Básico',
        'yellow': 'Intermedio',
        'green': 'Avanzado'
    };
    return statusMap[statusKey] || statusKey;
}

function downloadPDF() {
    const doc = new jspdf.jsPDF();
    const form = document.getElementById('commercial-form');
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 14;

    // --- Paleta de Colores ---
    const primaryColor = '#2c3e50';
    const secondaryColor = '#34495e';
    const textColor = '#0f0f0f';
    const headerColor = '#1a252f';

    // --- Función para el Encabezado y Pie de Página ---
    const addHeaderFooter = () => {
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);

            // Encabezado
            doc.setFillColor(headerColor);
            doc.rect(0, 0, pageWidth, 25, 'F');

            // <<< CORRECCIÓN APLICADA AQUÍ para restaurar el estilo del logo
            if (typeof logoBase64 !== 'undefined' && logoBase64) {
                const borderRadius = 3;
                const logoBgPadding = 2;
                const imageWidth = 25; // Aumentado ligeramente para mejor visibilidad
                const aspectRatio = 190 / 107; // Aspect ratio real del logo
                const imageHeight = imageWidth / aspectRatio;

                const bgWidth = imageWidth + (logoBgPadding * 2);
                const bgHeight = imageHeight + (logoBgPadding * 2);

                const bgX = margin;
                const bgY = (25 - bgHeight) / 2; // Centra el fondo verticalmente

                const logoX = bgX + logoBgPadding;
                const logoY = bgY + logoBgPadding;

                // 1. Dibuja el fondo blanco con bordes redondeados
                doc.setFillColor('#FFFFFF');
                doc.roundedRect(bgX, bgY, bgWidth, bgHeight, borderRadius, borderRadius, 'F');

                // 2. Dibuja el logo encima del fondo
                doc.addImage(logoBase64, 'PNG', logoX, logoY, imageWidth, imageHeight);
            }

            doc.setFontSize(10);
            doc.setTextColor('#FFFFFF');
            doc.setFont('helvetica', 'bold');
            doc.text("FICHA DE VALORACIÓN COMERCIAL", pageWidth / 2, 15, { align: 'center' });

            // Pie de página
            doc.setFontSize(8);
            doc.setTextColor(secondaryColor);
            const footerText = `Página ${i} de ${pageCount}`;
            doc.text(footerText, pageWidth / 2, pageHeight - 10, { align: 'center' });
            doc.line(margin, pageHeight - 15, pageWidth - margin, pageHeight - 15);
        }
    };

    let startY = 35;

    doc.setFontSize(11);
    doc.setTextColor(textColor);
    doc.setFont('helvetica', 'normal');
    doc.text(`Fecha de evaluación: ${new Date().toLocaleDateString()}`, pageWidth - margin, startY, { align: 'right' });
    startY += 10;

    doc.setFontSize(16);
    doc.setTextColor(primaryColor);
    doc.setFont('helvetica', 'bold');
    doc.text("1. Información de la empresa", margin, startY);
    startY += 4;
    doc.setDrawColor(primaryColor);
    doc.line(margin, startY, pageWidth - margin, startY);
    startY += 8;

    const companyInfo = [
        ['Nombre:', form.nombre_empresa.value, 'NIT:', form.nit.value],
        ['Ubicación:', form.ubicacion.value, 'Responsable:', form.representante_legal.value],
        ['Tipo de Organización:', form.tipo_organizacion.value, 'Colaboradores:', form.numero_colaboradores.value],
        ['Tiempo de Conformación:', form.tiempo_conformacion.value, 'Email:', form.correo_electronico.value],
        ['Productos/Servicios:', form.tipo_productos_servicios.value, 'Celular:', form.celular.value]
    ];

    doc.autoTable({
        startY: startY,
        body: companyInfo,
        theme: 'plain',
        styles: { fontSize: 10, textColor: textColor, cellPadding: { top: 1.5, right: 2, bottom: 1.5, left: 0 } },
        columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 45 },
            1: { cellWidth: 'auto' },
            2: { fontStyle: 'bold', cellWidth: 40 },
            3: { cellWidth: 'auto' }
        }
    });

    startY = doc.previousAutoTable.finalY + 15;

    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(primaryColor);
    doc.text("2. Resultados de la evaluación", margin, startY);
    startY += 4;
    doc.setDrawColor(primaryColor);
    doc.line(margin, startY, pageWidth - margin, startY);
    startY += 8;
    
    // Recuerda asegurarte de que la función getStatusText existe
    const tableBody = resultsForExport.map(item => [
        item.Aspecto,
        `${item["Calificacion (0-50)"]}/50`,
        { content: getStatusText(item.Estado), styles: { halign: 'center' } }
    ]);

    doc.autoTable({
        startY: startY,
        head: [['Aspecto Evaluado', 'Calificación (0-50)', 'Estado']],
        body: tableBody,
        theme: 'grid',
        headStyles: { fillColor: primaryColor, textColor: '#FFFFFF', fontSize: 11, fontStyle: 'bold', halign: 'center' },
        styles: { fontSize: 10, textColor: textColor, cellPadding: 3, valign: 'middle' },
        didDrawCell: function (data) {
            if (data.column.index === 2 && data.cell.section === 'body') {
                const originalStatus = resultsForExport[data.row.index].Estado;
                data.cell.styles.fontStyle = 'bold';
                if (originalStatus === 'green') { data.cell.styles.textColor = [0, 100, 0]; }
                if (originalStatus === 'yellow') { data.cell.styles.textColor = [230, 150, 0]; }
                if (originalStatus === 'red') { data.cell.styles.textColor = [192, 57, 43]; }
            }
        }
    });

    addHeaderFooter();
    doc.save(`Ficha_Valoracion_${form.nombre_empresa.value.replace(/\s/g, '_')}.pdf`);
}   


function downloadExcelSummary() {
    // Format score with "/50" for the summary Excel
    const summaryData = resultsForExport.map(item => ({
        ...item,
        "Calificacion (0-50)": `${item["Calificacion (0-50)"]}/50`
    }));
    const ws = XLSX.utils.json_to_sheet(summaryData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Resumen de Resultados");
    XLSX.writeFile(wb, `Resumen_Valoracion_${document.getElementById('nombre_empresa').value.replace(/\s/g, '_')}.xlsx`);
}

function downloadExcelAllData() {
    // CORRECTION: Iterate through all localStorage items and include all questions.
    const form = document.getElementById('commercial-form');
    const allDataRows = [];
    const questionHeaders = new Map();

    // 1. Define all possible columns by iterating through the form structure
    form.querySelectorAll('.form-group').forEach(group => {
        const label = group.querySelector('label');
        const inputs = group.querySelectorAll('input[name], textarea[name]');
        if (label && inputs.length > 0) {
            const questionText = label.childNodes[0].nodeValue.replace(':', '').trim();
            const inputName = inputs[0].name;
            if (!questionHeaders.has(inputName)) {
                questionHeaders.set(inputName, questionText);
            }
        }
    });
     const headers = ['Fecha de Guardado', ...Array.from(questionHeaders.values())];


    // 2. Get all saved data keys from localStorage
    const savedKeys = Object.keys(localStorage).filter(k => k.startsWith('formdata-'));

    if (savedKeys.length === 0) {
        alert("No hay datos guardados para generar la matriz.");
        return;
    }

    // 3. Process each saved entry
    savedKeys.forEach(key => {
        const savedEntry = JSON.parse(localStorage.getItem(key));
        const savedData = savedEntry.formData;
        const rowData = {};

        // Add metadata
        rowData['Fecha de Guardado'] = new Date(savedEntry.savedAt).toLocaleString('es-CO');

        // Map saved data to the correct header
        for (const [name, questionText] of questionHeaders.entries()) {
            let value = savedData[name];
            if (value !== undefined) {
                 // Convert array (from checkboxes) to a string
                if (Array.isArray(value)) {
                    value = value.join(', ');
                }
                rowData[questionText] = value;
            } else {
                rowData[questionText] = ''; // Ensure the column exists even if empty
            }
        }
        allDataRows.push(rowData);
    });
    
    // 4. Create and download the Excel file
    const ws = XLSX.utils.json_to_sheet(allDataRows, {header: headers});
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Matriz de Datos");
    XLSX.writeFile(wb, `Matriz_Datos_Completos.xlsx`);
}


// --- LOCALSTORAGE FUNCTIONS ---

function saveDataToLocalStorage() {
    const form = document.getElementById('commercial-form');
    const nit = document.getElementById('nit').value.trim();
    if (!nit) {
        console.error("NIT es requerido para guardar los datos.");
        return;
    }
    const key = `formdata-${nit}`;
    const data = {
        formData: {},
        savedAt: new Date().toISOString(),
        companyName: document.getElementById('nombre_empresa').value
    };

    const elements = form.elements;
    for (let i = 0; i < elements.length; i++) {
        const el = elements[i];
        if (el.name) {
            if (el.type === 'radio') {
                 if (el.checked) {
                   data.formData[el.name] = el.value;
                 }
            } else if (el.type === 'checkbox') {
                if (!data.formData[el.name]) data.formData[el.name] = [];
                if (el.checked) {
                   data.formData[el.name].push(el.value);
                }
            } else {
                data.formData[el.name] = el.value;
            }
        }
    }
    localStorage.setItem(key, JSON.stringify(data));
    alert(`Datos para la empresa "${data.companyName}" guardados/actualizados con éxito.`);
}


function loadSavedData() {
    const list = document.getElementById('saved-data-list');
    list.innerHTML = ''; 
    const keys = Object.keys(localStorage).filter(k => k.startsWith('formdata-'));

    if (keys.length === 0) {
        list.innerHTML = '<li>No hay datos guardados.</li>';
        return;
    }

    keys.forEach(key => {
        try {
            const data = JSON.parse(localStorage.getItem(key));
            const nit = key.replace('formdata-', '');
            const date = new Date(data.savedAt).toLocaleString('es-CO');

            const li = document.createElement('li');
            li.innerHTML = `
                <div class="entry-info">
                    <span class="company-name">${data.companyName || 'Sin Nombre'}</span>
                    <span class="entry-meta">NIT: ${nit} | Guardado: ${date}</span>
                </div>
                <div class="entry-actions">
                    <button onclick="populateForm('${key}')">Modificar</button>
                    <button class="secondary-action" onclick="loadAndShowResults('${key}')">Ver Resultados</button>
                    <button class="danger" onclick="deleteData('${key}')">Eliminar</button>
                </div>
            `;
            list.appendChild(li);
        } catch (e) {
            console.error(`Error al parsear datos para la clave ${key}:`, e);
        }
    });
}


function populateForm(key) {
    const dataString = localStorage.getItem(key);
    if (!dataString) return;

    const data = JSON.parse(dataString).formData;
    const form = document.getElementById('commercial-form');
    form.reset(); 

    document.querySelectorAll('.hidden[id]').forEach(el => {
        if(!el.classList.contains('form-phase')) {
             el.classList.add('hidden');
        }
    });

    Object.keys(data).forEach(name => {
        const elements = form.elements[name];
        const value = data[name];

        if (!elements) return;
        
        if (elements.nodeType === 'RADIO' || (elements.length && elements[0].type === 'radio')) {
             form.querySelectorAll(`input[name="${name}"]`).forEach(el => {
                 if (el.value === value) {
                     el.checked = true;
                     if(el.onclick) el.onclick();
                 }
             });
        } else if (elements.length && elements[0].type === 'checkbox') {
             const values = Array.isArray(value) ? value : [value];
             elements.forEach(el => {
                if (values.includes(el.value)) {
                    el.checked = true;
                    if(el.onclick) el.onclick();
                }
             });
        } else {
             if (elements.value !== undefined) {
                elements.value = value;
             }
        }
    });

    closeModal();
    currentPhase = 0;
    returnToForm();
    showPhase(0); 
    alert('Datos cargados en el formulario. Ya puedes revisarlos o modificarlos.');
}

function deleteData(key) {
    if (confirm('¿Estás seguro de que quieres eliminar estos datos? Esta acción no se puede deshacer.')) {
        localStorage.removeItem(key);
        loadSavedData();
    }
}

function openModal() {
    loadSavedData();
    document.getElementById('manage-data-modal').classList.add('visible');
}

function closeModal() {
    document.getElementById('manage-data-modal').classList.remove('visible');
}

function loadAndShowResults(key) {
    const dataString = localStorage.getItem(key);
    if (!dataString) return;

    const savedEntry = JSON.parse(dataString);
    const data = savedEntry.formData;
    const form = document.getElementById('commercial-form');
    form.reset();

    // Ocultar todos los elementos condicionales antes de popular
    document.querySelectorAll('.form-group.hidden, div.hidden[id]').forEach(el => {
        if(!el.classList.contains('form-phase')) {
             el.classList.add('hidden');
        }
    });

    // Popular el formulario con los datos de localStorage
    Object.keys(data).forEach(name => {
        const elements = form.elements[name];
        const value = data[name];

        if (!elements) return;

        // Manejar radio buttons
        if (elements.nodeType === 'RADIO' || (elements.length && elements[0].type === 'radio')) {
             form.querySelectorAll(`input[name="${name}"]`).forEach(el => {
                 if (el.value === value) {
                     el.checked = true;
                     // Disparar onclick para mostrar campos dependientes
                     if(el.onclick) el.onclick();
                 }
             });
        // Manejar checkboxes
        } else if (elements.length && elements[0].type === 'checkbox') {
             const values = Array.isArray(value) ? value : [value];
             elements.forEach(el => {
                if (values.includes(el.value)) {
                    el.checked = true;
                    if(el.onclick) el.onclick();
                }
             });
        // Manejar otros tipos de input
        } else {
             if (elements.value !== undefined) {
                elements.value = value;
             }
        }
    });

    // Calcular los resultados
    calculateResults();

    // Actualizar el nombre de la empresa en la página de resultados
    document.getElementById('results-company-name').textContent = savedEntry.companyName || 'Resultados';

    // Cambiar la vista del formulario a los resultados
    document.getElementById('form-container').style.display = 'none';
    document.getElementById('results').classList.remove('hidden');

    // Cerrar la ventana modal
    closeModal();
}

</script>

</body>
</html>
